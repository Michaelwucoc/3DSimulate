# 3D重建后端服务配置文件
# 复制此文件为 .env 并根据需要修改配置

# ================================
# 服务器配置
# ================================
HOST=0.0.0.0
PORT=8000
DEBUG=True
FLASK_ENV=development

# ================================
# 文件存储配置
# ================================
UPLOAD_FOLDER=./uploads
OUTPUT_FOLDER=./outputs
TEMP_FOLDER=./temp
LOG_FOLDER=./logs

# 文件大小限制（字节）
MAX_FILE_SIZE=524288000  # 500MB
MAX_FILES_PER_TASK=100

# 支持的文件格式（逗号分隔）
ALLOWED_VIDEO_EXTENSIONS=mp4,avi,mov,mkv,webm,m4v,flv,wmv
ALLOWED_IMAGE_EXTENSIONS=jpg,jpeg,png,bmp,tiff,tif,webp

# ================================
# NeRF配置
# ================================
NERF_MAX_ITERATIONS=30000
NERF_VIEWER_PORT=7007
NERF_SAVE_ITERATIONS=7000,30000
NERF_TEST_ITERATIONS=7000,30000
NERF_CHECKPOINT_ITERATIONS=7000,30000
NERF_DENSIFY_FROM_ITER=500
NERF_DENSIFY_UNTIL_ITER=15000
NERF_DENSIFICATION_INTERVAL=100
NERF_OPACITY_RESET_INTERVAL=3000
NERF_DENSIFY_GRAD_THRESHOLD=0.0002

# ================================
# 3D Gaussian Splatting配置
# ================================
GS_ITERATIONS=30000
GS_POSITION_LR_INIT=0.00016
GS_POSITION_LR_FINAL=0.0000016
GS_POSITION_LR_DELAY_MULT=0.01
GS_POSITION_LR_MAX_STEPS=30000
GS_FEATURE_LR=0.0025
GS_OPACITY_LR=0.05
GS_SCALING_LR=0.005
GS_ROTATION_LR=0.001
GS_PERCENT_DENSE=0.01
GS_LAMBDA_DSSIM=0.2
GS_DENSIFICATION_INTERVAL=100
GS_OPACITY_RESET_INTERVAL=3000
GS_DENSIFY_FROM_ITER=500
GS_DENSIFY_UNTIL_ITER=15000
GS_DENSIFY_GRAD_THRESHOLD=0.0002
GS_RANDOM_BACKGROUND=False
GS_RESOLUTION=-1
GS_DATA_DEVICE=cuda
GS_WHITE_BACKGROUND=False
GS_SH_DEGREE=3

# ================================
# COLMAP配置
# ================================
COLMAP_MATCHER_TYPE=exhaustive
COLMAP_CAMERA_MODEL=OPENCV
COLMAP_SINGLE_CAMERA=False
COLMAP_THREADS=-1
COLMAP_VOCAB_TREE_PATH=
COLMAP_GPU_INDEX=-1
COLMAP_USE_GPU=True

# ================================
# 模型转换配置
# ================================
CONVERSION_FORMATS=ply,obj,gltf,glb,fbx,stl
DEFAULT_CONVERSION_FORMAT=ply
MODEL_OPTIMIZATION=True
THUMBNAIL_SIZE=512,512
THUMBNAIL_FORMAT=png

# ================================
# 渲染配置
# ================================
RENDER_WIDTH=1920
RENDER_HEIGHT=1080
RENDER_FPS=30
RENDER_FORMAT=mp4
RENDER_QUALITY=high
RENDER_SAMPLES=128

# ================================
# GPU配置
# ================================
CUDA_DEVICE=cuda:0
GPU_MEMORY_FRACTION=0.8
USE_MIXED_PRECISION=True
GPU_MEMORY_GROWTH=True

# ================================
# 性能配置
# ================================
MAX_CONCURRENT_TASKS=2
TASK_TIMEOUT=3600  # 1小时（秒）
CLEANUP_INTERVAL=86400  # 24小时（秒）
MAX_STORAGE_DAYS=7  # 文件保留天数
WORKER_PROCESSES=4
WORKER_THREADS=2
WORKER_TIMEOUT=300

# ================================
# 日志配置
# ================================
LOG_LEVEL=INFO
LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s
LOG_MAX_BYTES=10485760  # 10MB
LOG_BACKUP_COUNT=5
LOG_TO_CONSOLE=True
LOG_TO_FILE=True

# ================================
# 数据库配置（可选）
# ================================
# DATABASE_URL=sqlite:///app.db
# DATABASE_POOL_SIZE=10
# DATABASE_POOL_TIMEOUT=30
# DATABASE_POOL_RECYCLE=3600

# ================================
# Redis配置（可选，用于任务队列）
# ================================
# REDIS_URL=redis://localhost:6379/0
# REDIS_PASSWORD=
# REDIS_DB=0
# REDIS_SOCKET_TIMEOUT=30
# REDIS_CONNECTION_POOL_MAX_CONNECTIONS=50

# ================================
# Celery配置（可选，用于异步任务）
# ================================
# CELERY_BROKER_URL=redis://localhost:6379/0
# CELERY_RESULT_BACKEND=redis://localhost:6379/0
# CELERY_TASK_SERIALIZER=json
# CELERY_RESULT_SERIALIZER=json
# CELERY_ACCEPT_CONTENT=json
# CELERY_TIMEZONE=UTC
# CELERY_ENABLE_UTC=True
# CELERY_TASK_ROUTES={
#     'app.tasks.reconstruction': {'queue': 'reconstruction'},
#     'app.tasks.conversion': {'queue': 'conversion'}
# }

# ================================
# 外部工具路径
# ================================
COLMAP_PATH=colmap
FFMPEG_PATH=ffmpeg
BLENDER_PATH=blender
MESHLAB_PATH=meshlabserver
PYTHON_PATH=python

# ================================
# API配置
# ================================
API_PREFIX=/api
API_VERSION=v1
API_TITLE=3D Reconstruction API
API_DESCRIPTION=3D重建服务API
API_DOCS_URL=/docs
API_REDOC_URL=/redoc
API_OPENAPI_URL=/openapi.json

# ================================
# CORS配置
# ================================
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:5174,http://localhost:5175,http://localhost:5176
CORS_METHODS=GET,POST,PUT,DELETE,OPTIONS
CORS_HEADERS=Content-Type,Authorization,X-Requested-With
CORS_CREDENTIALS=True

# ================================
# 安全配置
# ================================
SECRET_KEY=your-secret-key-change-this-in-production
JWT_SECRET_KEY=your-jwt-secret-key-change-this-in-production
JWT_ACCESS_TOKEN_EXPIRES=3600  # 1小时
JWT_REFRESH_TOKEN_EXPIRES=2592000  # 30天

# ================================
# 监控配置
# ================================
MONITORING_ENABLED=True
METRICS_ENDPOINT=/metrics
HEALTH_ENDPOINT=/health
STATUS_ENDPOINT=/status

# ================================
# 开发配置
# ================================
DEV_RELOAD=True
DEV_DEBUGGER=True
DEV_PROFILER=False
DEV_MOCK_RECONSTRUCTION=False  # 是否使用模拟重建（用于测试）

# ================================
# 生产配置
# ================================
PROD_WORKERS=4
PROD_WORKER_CLASS=sync
PROD_WORKER_CONNECTIONS=1000
PROD_MAX_REQUESTS=1000
PROD_MAX_REQUESTS_JITTER=100
PROD_TIMEOUT=300
PROD_KEEPALIVE=5
PROD_PRELOAD_APP=True

# ================================
# 实验性功能
# ================================
EXPERIMENTAL_FEATURES=False
EXPERIMENTAL_4D_RECONSTRUCTION=False
EXPERIMENTAL_DIFFUSION_PRIOR=False
EXPERIMENTAL_SCENE_EDITING=False
EXPERIMENTAL_DYNAMIC_OBJECTS=False